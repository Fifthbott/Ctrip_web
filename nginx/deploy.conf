server {
    listen 80;
    server_name localhost;  # 后续可替换为您的域名

    client_max_body_size 100M;  # 允许上传的最大文件大小

    # 自定义日志格式，使用东八区时间
    log_format  cst_format  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent"';
    
    # 设置本地时区为东八区
    env TZ=Asia/Shanghai;
    
    # 使用自定义日志格式
    access_log /var/log/nginx/access.log cst_format;
    error_log /var/log/nginx/error.log;

    # 全局API限制
    location /api/ {
        # 添加速率限制: 120请求/分钟，允许突发20个请求
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://ctrip_api:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 文件上传接口限制
    location ~ ^/api/(users/me/avatar|users/avatar|travel-logs/upload-images|travel-logs/upload-video)$ {
        # 上传限制: 10请求/分钟，允许突发5个请求
        limit_req zone=upload_limit burst=5 nodelay;
        
        proxy_pass http://ctrip_api:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 文件上传可能需要更长的超时时间
        proxy_read_timeout 300s;
    }

    # 文件下载API - 添加缓存和速率限制
    location ~ ^/api/download/(images|videos|avatars)/(.+)$ {
        # 较高的限制：600请求/分钟，允许突发50请求
        limit_req zone=download_limit burst=50 nodelay;
        
        # 忽略客户端缓存控制头
        proxy_ignore_headers Cache-Control;
        proxy_hide_header Cache-Control;
        proxy_hide_header Pragma;
        
        # 使用下载专用缓存
        proxy_cache download_cache;
        proxy_cache_valid 200 7d;  # 缓存成功响应7天
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;  # 当后端出错时使用过期缓存
        proxy_cache_key $uri;  # 使用URI作为缓存键
        proxy_cache_min_uses 1;  # 访问一次就缓存
        
        # 强制缓存设置
        add_header Cache-Control "public, max-age=604800, immutable";
        add_header Pragma "public";
        expires 7d;
        
        # 添加缓存状态头
        add_header X-Cache-Status $upstream_cache_status;
        
        # 添加条件请求头传递
        proxy_set_header If-Modified-Since $http_if_modified_since;
        proxy_set_header If-None-Match $http_if_none_match;
        
        # 确保正确传递缓存头
        proxy_pass_header Cache-Control;
        proxy_pass_header Expires;
        proxy_pass_header ETag;
        proxy_pass_header Last-Modified;
        
        proxy_pass http://ctrip_api:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 图片和静态文件访问接口 - 更高的限制和缓存配置
    location ~ ^/uploads/.*\.(jpg|jpeg|png|gif|webp|svg|mp4|webm)$ {
        # 较高的限制：600请求/分钟，允许突发50请求
        limit_req zone=download_limit burst=50 nodelay;
        
        # 直接提供静态文件
        alias /app/src/uploads/;
        
        # 缓存配置
        expires 7d;  # 延长缓存时间到7天
        add_header Cache-Control "public, max-age=604800";
    }

    # 认证接口限制
    location ~ ^/api/users/(login|register)$ {
        # 添加更严格的限制: 5请求/分钟，允许突发3个请求
        limit_req zone=auth_limit burst=3 nodelay;

        proxy_pass http://ctrip_api:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 普通前端请求 - 没有速率限制
    location / {
        proxy_pass http://ctrip_frontend:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 健康检查 - 不限制访问频率
    location /api/health {
        proxy_pass http://ctrip_api:3000/api/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        access_log off;
    }
} 