# 旅游笔记服务 API 文档

## 基本信息

- **基础URL**: `/api`
- **响应格式**: JSON
- **认证方式**: JWT (Bearer Token)
- **版本**: 1.0.0

## 通用响应格式

### 成功响应
```json
{
  "status": "success",
  "message": "操作成功",
  "data": { 
    // 返回的数据
  }
}
```

### 分页响应
```json
{
  "status": "success",
  "message": "获取数据成功",
  "data": {
    "items": [ /* 数据项列表 */ ],
    "pagination": {
      "total": 100,
      "page": 1,
      "limit": 10,
      "pages": 10
    }
  }
}
```

### 错误响应
```json
{
  "status": "error",
  "message": "错误信息",
  "error": {
    "code": "ERROR_CODE",
    "details": {} // 可选的详细错误信息
  }
}
```

## 公共接口

### 系统状态

#### 获取首页信息
- **URL**: `/`
- **方法**: `GET`
- **描述**: 获取API服务基本信息
- **响应示例**:
```json
{
  "status": "success",
  "message": "旅游笔记服务已成功启动",
  "version": "1.0.0",
  "endpoints": {
    "users": "/api/users",
    "travelLogs": "/api/travel-logs",
    "audits": "/api/audits"
  }
}
```

#### 健康检查
- **URL**: `/health`
- **方法**: `GET`
- **描述**: 检查API服务是否正常运行
- **响应示例**:
```json
{
  "status": "success",
  "message": "服务正常运行",
  "timestamp": "2023-05-26T08:30:22.123Z"
}
```

## 用户 APIs

### 用户注册
- **URL**: `/users/register`
- **方法**: `POST`
- **认证**: 不需要
- **描述**: 注册新用户账号
- **请求格式**: `multipart/form-data`
- **请求参数**:
  - `username`: 用户名 (必须，3-20个字符)
  - `password`: 密码 (必须，至少6个字符)
  - `nickname`: 昵称 (可选)
  - `avatar`: 用户头像文件 (可选，图片文件)
- **响应示例**:
```json
{
  "status": "success",
  "message": "注册成功",
  "data": {
    "user": {
      "user_id": 1,
      "username": "user123",
      "nickname": "旅行者",
      "avatar": "/uploads/avatars/user123.webp",
      "role": "user"
    },
    "token": "jwt-token-string"
  }
}
```

### 用户登录
- **URL**: `/users/login`
- **方法**: `POST`
- **认证**: 不需要
- **描述**: 用户登录并获取JWT令牌
- **请求格式**: `application/json`
- **请求参数**:
  - `username`: 用户名 (必须)
  - `password`: 密码 (必须)
- **响应示例**:
```json
{
  "status": "success",
  "message": "登录成功",
  "data": {
    "user": {
      "user_id": 1,
      "username": "user123",
      "nickname": "旅行者",
      "avatar": "/uploads/avatars/user123.webp",
      "role": "user"
    },
    "token": "jwt-token-string"
  }
}
```

### 获取当前用户信息
- **URL**: `/users/me`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取当前登录用户的信息
- **响应示例**:
```json
{
  "status": "success",
  "data": {
    "user": {
      "user_id": 1,
      "username": "user123",
      "nickname": "旅行者",
      "avatar": "/uploads/avatars/user123.webp",
      "role": "user",
      "created_at": "2023-05-26T08:30:22.123Z"
    }
  }
}
```

### 更新用户信息
- **URL**: `/users/me`
- **方法**: `PUT`
- **认证**: 需要
- **描述**: 更新当前用户的个人信息
- **请求格式**: `application/json`
- **请求参数**:
  - `nickname`: 新昵称 (可选)
  - `password`: 新密码 (可选)
- **响应示例**:
```json
{
  "status": "success",
  "message": "用户信息更新成功",
  "data": {
    "user": {
      "user_id": 1,
      "username": "user123",
      "nickname": "新昵称",
      "avatar": "/uploads/avatars/user123.webp",
      "role": "user"
    }
  }
}
```

### 更新用户头像
- **URL**: `/users/me/avatar`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 上传或更新用户头像
- **请求格式**: `multipart/form-data`
- **请求参数**:
  - `avatar`: 头像图片文件 (必须，图片文件)
- **响应示例**:
```json
{
  "status": "success",
  "message": "头像更新成功",
  "data": {
    "avatar": "/uploads/avatars/user123.webp"
  }
}
```

### 获取所有用户 (管理员)
- **URL**: `/users`
- **方法**: `GET`
- **认证**: 需要
- **权限**: 管理员
- **描述**: 获取所有用户列表(分页)
- **查询参数**:
  - `page`: 页码 (默认 1)
  - `limit`: 每页数量 (默认 10)
- **响应示例**:
```json
{
  "status": "success",
  "data": {
    "users": [
      {
        "user_id": 1,
        "username": "user123",
        "nickname": "旅行者",
        "avatar": "/uploads/avatars/user123.webp",
        "role": "user",
        "status": "active",
        "created_at": "2023-05-26T08:30:22.123Z"
      },
      // 更多用户...
    ],
    "pagination": {
      "total": 50,
      "page": 1,
      "limit": 10,
      "pages": 5
    }
  }
}
```

## 游记 APIs

### 获取游记列表
- **URL**: `/travel-logs`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取公开的游记列表(分页)
- **查询参数**:
  - `page`: 页码 (默认 1)
  - `limit`: 每页数量 (默认 10)
  - `search`: 搜索关键词 (可选)
- **响应示例**:
```json
{
  "status": "success",
  "message": "获取游记列表成功",
  "data": {
    "items": [
      {
        "log_id": 1,
        "title": "北京之旅",
        "content": "游记内容...",
        "image_urls": [
          "/uploads/images/beijing_medium.webp"
        ],
        "video_url": "/uploads/videos/beijing_processed.mp4",
        "created_at": "2023-05-26T08:30:22.123Z",
        "comment_count": 10,
        "like_count": 25,
        "favorite_count": 5,
        "author": {
          "user_id": 1,
          "nickname": "旅行者",
          "avatar": "/uploads/avatars/user123.webp"
        },
        "tags": [
          { "tag_id": 1, "tag_name": "北京" },
          { "tag_id": 2, "tag_name": "文化" }
        ]
      },
      // 更多游记...
    ],
    "pagination": {
      "total": 100,
      "page": 1,
      "limit": 10,
      "pages": 10
    }
  }
}
```

### 获取游记详情
- **URL**: `/travel-logs/:id`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取单个游记的详细信息
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "获取游记详情成功",
  "data": {
    "travel_log": {
      "log_id": 1,
      "title": "北京之旅",
      "content": "游记详细内容...",
      "image_urls": [
        "/uploads/images/beijing_medium.webp"
      ],
      "video_url": "/uploads/videos/beijing_processed.mp4",
      "thumbnail_url": "/uploads/thumbnails/beijing.jpg",
      "created_at": "2023-05-26T08:30:22.123Z",
      "updated_at": "2023-05-26T10:22:45.678Z",
      "comment_count": 10,
      "like_count": 25,
      "favorite_count": 5,
      "author": {
        "user_id": 1,
        "nickname": "旅行者",
        "avatar": "/uploads/avatars/user123.webp"
      },
      "tags": [
        { "tag_id": 1, "tag_name": "北京" },
        { "tag_id": 2, "tag_name": "文化" }
      ],
      "comments": [
        {
          "comment_id": 1,
          "content": "很棒的游记!",
          "created_at": "2023-05-26T09:12:34.567Z",
          "author": {
            "user_id": 2,
            "nickname": "评论者",
            "avatar": "/uploads/avatars/user456.webp"
          }
        },
        // 更多评论...
      ]
    }
  }
}
```

### 获取当前用户的游记列表
- **URL**: `/travel-logs/me`
- **方法**: `GET`
- **认证**: 需要
- **描述**: 获取当前用户创建的游记列表
- **查询参数**:
  - `page`: 页码 (默认 1)
  - `limit`: 每页数量 (默认 10)
  - `status`: 游记状态 (可选，'pending'/'approved'/'rejected')
- **响应示例**:
```json
{
  "status": "success",
  "message": "获取个人游记列表成功",
  "data": {
    "items": [
      {
        "log_id": 1,
        "title": "北京之旅",
        "content": "游记内容...",
        "image_urls": [
          "/uploads/images/beijing_medium.webp"
        ],
        "video_url": "/uploads/videos/beijing_processed.mp4",
        "status": "approved",
        "created_at": "2023-05-26T08:30:22.123Z",
        "updated_at": "2023-05-26T10:22:45.678Z",
        "comment_count": 10,
        "like_count": 25,
        "favorite_count": 5,
        "tags": [
          { "tag_id": 1, "tag_name": "北京" },
          { "tag_id": 2, "tag_name": "文化" }
        ]
      },
      // 更多游记...
    ],
    "pagination": {
      "total": 20,
      "page": 1,
      "limit": 10,
      "pages": 2
    }
  }
}
```

### 创建游记
- **URL**: `/travel-logs`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 创建新的游记
- **请求格式**: `application/json`
- **请求参数**:
  - `title`: 游记标题 (必须)
  - `content`: 游记内容 (必须)
  - `image_urls`: 图片URL数组 (可选)
  - `video_url`: 视频URL (可选)
  - `tags`: 标签数组 (可选)
- **响应示例**:
```json
{
  "status": "success",
  "message": "游记创建成功，等待审核",
  "data": {
    "travel_log": {
      "log_id": 1,
      "title": "北京之旅",
      "status": "pending",
      "created_at": "2023-05-26T08:30:22.123Z"
    }
  }
}
```

### 更新游记
- **URL**: `/travel-logs/:id`
- **方法**: `PUT`
- **认证**: 需要
- **描述**: 更新现有游记
- **路径参数**:
  - `id`: 游记ID
- **请求格式**: `application/json`
- **请求参数**:
  - `title`: 游记标题 (可选)
  - `content`: 游记内容 (可选)
  - `image_urls`: 图片URL数组 (可选)
  - `video_url`: 视频URL (可选)
  - `tags`: 标签数组 (可选)
- **响应示例**:
```json
{
  "status": "success",
  "message": "游记更新成功，等待审核",
  "data": {
    "travel_log": {
      "log_id": 1,
      "title": "北京之旅(更新)",
      "status": "pending",
      "updated_at": "2023-05-26T10:22:45.678Z"
    }
  }
}
```

### 删除游记
- **URL**: `/travel-logs/:id`
- **方法**: `DELETE`
- **认证**: 需要
- **描述**: 删除游记
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "游记删除成功"
}
```

### 上传图片
- **URL**: `/travel-logs/upload-images`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 上传游记图片
- **请求格式**: `multipart/form-data`
- **请求参数**:
  - `images`: 图片文件 (必须，最多10张)
- **响应示例**:
```json
{
  "status": "success",
  "message": "图片上传并处理成功",
  "data": {
    "images": [
      {
        "original": "/uploads/images/image1_original.webp",
        "high": "/uploads/images/image1_high.webp",
        "medium": "/uploads/images/image1_medium.webp",
        "thumb": "/uploads/images/image1_thumb.webp"
      }
    ],
    "image_urls": [
      "/uploads/images/image1_medium.webp"
    ],
    "thumbnails": [
      "/uploads/images/image1_thumb.webp"
    ]
  }
}
```

### 上传视频
- **URL**: `/travel-logs/upload-video`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 上传游记视频
- **请求格式**: `multipart/form-data`
- **请求参数**:
  - `video`: 视频文件 (必须)
- **响应示例**:
```json
{
  "status": "success",
  "message": "视频上传成功",
  "data": {
    "video_url": "/uploads/videos/video1_processed.mp4",
    "thumbnail_url": "/uploads/thumbnails/video1.jpg",
    "cover_url": "/uploads/covers/video1_cover.jpg",
    "status": "processing",
    "process_id": "e1533f61-f4ba-47b4-8368-cad441ddd311",
    "message": "视频已上传，正在后台处理中，您可以继续操作。"
  }
}
```

### 获取视频处理进度
- **URL**: `/travel-logs/video-progress/:id`
- **方法**: `GET`
- **认证**: 不需要
- **描述**: 获取视频处理的实时进度
- **路径参数**:
  - `id`: 处理ID (process_id，上传视频api的返回结果字段) 
- **响应示例**:
```json
{
  "status": "success",
  "message": "获取视频处理进度成功",
  "data": {
    "process_id": "e1533f61-f4ba-47b4-8368-cad441ddd311",
    "status": "processing_video",
    "progress": 65,
    "message": "视频处理中 65%...",
    "created_at": "2023-05-26T08:30:22.123Z",
    "filename": "video1_aed6745a"
  }
}
```



### 创建评论

- **URL**: `/api/comments`
- **方法**: `POST`
- **请求格式**: `application/json`
- **描述**: 创建游记评论
- **认证**: 需要

**请求参数**:

| 参数名    | 类型   | 必填 | 描述                              |
|-----------|--------|------|----------------------------------|
| log_id    | number | 是   | 游记ID                           |
| content   | string | 是   | 评论内容，1-500个字符             |

**响应示例**:

```json
{
  "status": "success",
  "message": "评论发布成功",
  "data": {
    "comment": {
      "comment_id": 1,
      "content": "非常精彩的游记！",
      "created_at": "2023-07-02T09:00:00.000Z",
      "author": {
        "user_id": 2,
        "nickname": "评论者",
        "avatar": "commenter.jpg"
      }
    }
  }
}
```

### 删除评论

- **URL**: `/api/comments/:id`
- **方法**: `DELETE`
- **描述**: 删除自己的评论(或管理员删除任意评论)
- **认证**: 需要

**URL参数**:

| 参数名 | 类型   | 描述   |
|--------|--------|--------|
| id     | number | 评论ID |

**响应示例**:

```json
{
  "status": "success",
  "message": "评论删除成功"
}
```

### 获取游记评论列表

- **URL**: `/api/travel-logs/:id/comments`
- **方法**: `GET`
- **描述**: 获取某篇游记的评论列表
- **认证**: 不需要

**URL参数**:

| 参数名 | 类型   | 描述   |
|--------|--------|--------|
| id     | number | 游记ID |

**查询参数**:

| 参数名 | 类型   | 必填 | 描述                 |
|--------|--------|------|---------------------|
| page   | number | 否   | 页码，默认为1        |
| limit  | number | 否   | 每页记录数，默认为10 |

**响应示例**:

```json
{
  "status": "success",
  "message": "获取评论列表成功",
  "data": {
    "items": [
      {
        "comment_id": 1,
        "content": "非常精彩的游记！",
        "created_at": "2023-07-02T09:00:00.000Z",
        "author": {
          "user_id": 2,
          "nickname": "评论者",
          "avatar": "commenter.jpg"
        }
      },
      // 更多评论...
    ],
    "pagination": {
      "total": 15,
      "page": 1,
      "limit": 10,
      "pages": 2
    }
  }
}
```

### 点赞游记
- **URL**: `/travel-logs/:id/like`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 对游记进行点赞
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "点赞成功",
  "data": {
    "like_count": 26
  }
}
```

### 取消点赞
- **URL**: `/travel-logs/:id/like`
- **方法**: `DELETE`
- **认证**: 需要
- **描述**: 取消对游记的点赞
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "取消点赞成功",
  "data": {
    "like_count": 25
  }
}
```

### 收藏游记
- **URL**: `/travel-logs/:id/favorite`
- **方法**: `POST`
- **认证**: 需要
- **描述**: 收藏游记
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "收藏成功",
  "data": {
    "favorite_count": 6
  }
}
```

### 取消收藏
- **URL**: `/travel-logs/:id/favorite`
- **方法**: `DELETE`
- **认证**: 需要
- **描述**: 取消收藏游记
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "取消收藏成功",
  "data": {
    "favorite_count": 5
  }
}
```

## 审核 APIs (管理员/审核员)

### 获取待审核游记列表
- **URL**: `/audits/travel-logs`
- **方法**: `GET`
- **认证**: 需要
- **权限**: 管理员/审核员
- **描述**: 获取需要审核的游记列表
- **查询参数**:
  - `page`: 页码 (默认 1)
  - `limit`: 每页数量 (默认 10)
  - `status`: 游记状态 (可选，'pending'/'approved'/'rejected')
- **响应示例**:
```json
{
  "status": "success",
  "message": "获取待审核游记列表成功",
  "data": {
    "items": [
      {
        "log_id": 1,
        "title": "北京之旅",
        "content": "游记内容...",
        "image_urls": [
          "/uploads/images/beijing_medium.webp"
        ],
        "video_url": "/uploads/videos/beijing_processed.mp4",
        "status": "pending",
        "created_at": "2023-05-26T08:30:22.123Z",
        "updated_at": "2023-05-26T08:30:22.123Z",
        "author": {
          "user_id": 1,
          "nickname": "旅行者",
          "avatar": "/uploads/avatars/user123.webp"
        }
      },
      // 更多游记...
    ],
    "pagination": {
      "total": 15,
      "page": 1,
      "limit": 10,
      "pages": 2
    }
  }
}
```

### 获取待审核游记详情
- **URL**: `/audits/travel-logs/:id`
- **方法**: `GET`
- **认证**: 需要
- **权限**: 管理员/审核员
- **描述**: 获取待审核游记的详细信息
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "获取待审核游记详情成功",
  "data": {
    "travel_log": {
      "log_id": 1,
      "title": "北京之旅",
      "content": "游记详细内容...",
      "image_urls": [
        "/uploads/images/beijing_medium.webp"
      ],
      "video_url": "/uploads/videos/beijing_processed.mp4",
      "thumbnail_url": "/uploads/thumbnails/beijing.jpg",
      "status": "pending",
      "created_at": "2023-05-26T08:30:22.123Z",
      "updated_at": "2023-05-26T08:30:22.123Z",
      "author": {
        "user_id": 1,
        "nickname": "旅行者",
        "avatar": "/uploads/avatars/user123.webp"
      },
      "tags": [
        { "tag_id": 1, "tag_name": "北京" },
        { "tag_id": 2, "tag_name": "文化" }
      ]
    }
  }
}
```

### 审核游记
- **URL**: `/audits/travel-logs/:id`
- **方法**: `POST`
- **认证**: 需要
- **权限**: 管理员/审核员
- **描述**: 审核游记(通过或拒绝)
- **路径参数**:
  - `id`: 游记ID
- **请求格式**: `application/json`
- **请求参数**:
  - `audit_status`: 审核状态 (必须，'approved'/'rejected')
  - `reason`: 拒绝原因 (当audit_status为'rejected'时必须)
- **响应示例**:
```json
{
  "status": "success",
  "message": "审核完成",
  "data": {
    "log_id": 1,
    "title": "北京之旅",
    "status": "approved",
    "audit_time": "2023-05-26T10:30:22.123Z"
  }
}
```

### 删除游记 (管理员)
- **URL**: `/audits/travel-logs/:id`
- **方法**: `DELETE`
- **认证**: 需要
- **权限**: 管理员
- **描述**: 管理员删除游记
- **路径参数**:
  - `id`: 游记ID
- **响应示例**:
```json
{
  "status": "success",
  "message": "游记已删除"
}
```

## 错误代码

| 代码 | 描述 |
|------|------|
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 权限不足 |
| 404 | 资源不存在 |
| 413 | 上传文件太大 |
| 422 | 数据验证失败 |
| 500 | 服务器内部错误 | 