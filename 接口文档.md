# 旅游社区API接口文档

## 基础信息

- **基础URL**: `/api`
- **响应格式**: JSON
- **身份认证**: 大部分接口需要在请求头中添加 `Authorization: Bearer {token}`

## 响应格式

所有API响应均使用统一的格式：

```json
{
  "status": "success",  // 状态: success或error
  "message": "操作成功",  // 操作提示信息
  "data": {  // 返回的数据，错误时可能没有此字段
    // 实际数据
  }
}
```

## 用户接口

### 注册

- **URL**: `/api/users/register`
- **方法**: POST
- **身份认证**: 否
- **请求体**:
  ```json
  {
    "email": "user@example.com",
    "password": "secure_password",
    "nickname": "用户昵称"
  }
  ```
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "注册成功",
    "data": {
      "user_id": 123,
      "email": "user@example.com",
      "nickname": "用户昵称",
      "role": "user"
    }
  }
  ```

### 登录

- **URL**: `/api/users/login`
- **方法**: POST
- **身份认证**: 否
- **请求体**:
  ```json
  {
    "email": "user@example.com",
    "password": "secure_password"
  }
  ```
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "登录成功",
    "data": {
      "token": "JWT令牌",
      "user": {
        "user_id": 123,
        "email": "user@example.com",
        "nickname": "用户昵称",
        "avatar": "avatars/filename.webp",
        "role": "user"
      }
    }
  }
  ```

### 获取个人信息

- **URL**: `/api/users/me`
- **方法**: GET
- **身份认证**: 是
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取个人信息成功",
    "data": {
      "user": {
        "user_id": 123,
        "email": "user@example.com",
        "nickname": "用户昵称",
        "avatar": "avatars/filename.webp",
        "bio": "个人简介",
        "role": "user",
        "created_at": "2023-01-01T00:00:00Z"
      }
    }
  }
  ```

### 更新个人信息

- **URL**: `/api/users/profile`
- **方法**: PUT
- **身份认证**: 是
- **请求体**:
  ```json
  {
    "nickname": "新昵称",
    "bio": "新的个人简介",
    "avatar": "avatars/new_avatar.webp"
  }
  ```
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "个人信息更新成功",
    "data": {
      "user": {
        "user_id": 123,
        "nickname": "新昵称",
        "avatar": "avatars/new_avatar.webp",
        "bio": "新的个人简介"
      }
    }
  }
  ```

### 上传头像

- **URL**: `/api/users/avatar`
- **方法**: POST
- **身份认证**: 是
- **请求类型**: `multipart/form-data`
- **表单字段**:
  - `avatar`: 图片文件
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "头像上传成功",
    "data": {
      "avatar": "avatars/filename.webp"
    }
  }
  ```

## 文件上传下载接口

### 上传图片

- **URL**: `/api/travel-logs/upload-images`
- **方法**: POST
- **身份认证**: 是
- **请求类型**: `multipart/form-data`
- **表单字段**:
  - `images`: 图片文件(可多选，最多10张)
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "图片上传并处理成功",
    "data": {
      "image_urls": [
        "images/file1.webp",
        "images/file2.webp"
      ]
    }
  }
  ```

### 上传视频

- **URL**: `/api/travel-logs/upload-video`
- **方法**: POST
- **身份认证**: 是
- **请求类型**: `multipart/form-data`
- **表单字段**:
  - `video`: 视频文件
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "视频上传成功",
    "data": {
      "video_url": "videos/filename.mp4",
      "cover_url": "images/filename_cover.webp",
      "status": "processing",
      "process_id": "处理ID",
      "message": "视频已上传，正在后台处理中，您可以继续操作。"
    }
  }
  ```

### 获取视频处理进度

- **URL**: `/api/travel-logs/video-progress/:id`
- **方法**: GET
- **身份认证**: 否
- **URL参数**:
  - `id`: 处理ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取视频处理进度成功",
    "data": {
      "process_id": "处理ID",
      "status": "processing_video",
      "progress": 45,
      "message": "视频处理中 45%..."
    }
  }
  ```

### 文件下载

- **URL**: `/api/download/:type/:filename`
- **方法**: GET
- **身份认证**: 否
- **URL参数**:
  - `type`: 文件类型(images, videos, avatars)
  - `filename`: 文件名
- **响应**: 直接返回文件的二进制数据，可以通过浏览器直接下载或查看

## 游记接口

### 创建游记

- **URL**: `/api/travel-logs`
- **方法**: POST
- **身份认证**: 是
- **请求体**:
  ```json
  {
    "title": "游记标题",
    "content": "游记内容",
    "image_urls": ["images/file1.webp", "images/file2.webp"],
    "video_url": "videos/filename.mp4",
    "cover_url": "images/filename_cover.webp",
    "tags": ["北京", "美食", "旅行"]
  }
  ```
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "游记创建成功，等待审核",
    "data": {
      "travel_log": {
        "log_id": 123,
        "title": "游记标题",
        "status": "pending",
        "created_at": "2023-01-01T00:00:00Z"
      }
    }
  }
  ```

### 获取游记列表

- **URL**: `/api/travel-logs`
- **方法**: GET
- **身份认证**: 否
- **查询参数**:
  - `page`: 页码(默认1)
  - `limit`: 每页数量(默认10)
  - `search`: 搜索关键词(可选)
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取游记列表成功",
    "data": {
      "travel_logs": [
        {
          "log_id": 123,
          "title": "游记标题",
          "content": "游记内容",
          "image_urls": ["images/file1.webp"],
          "video_url": "videos/filename.mp4",
          "cover_url": "images/filename_cover.webp",
          "created_at": "2023-01-01T00:00:00Z",
          "comment_count": 5,
          "like_count": 10,
          "favorite_count": 2,
          "author": {
            "user_id": 456,
            "nickname": "作者昵称",
            "avatar": "avatars/avatar.webp"
          },
          "tags": [
            {"tag_id": 1, "tag_name": "北京"},
            {"tag_id": 2, "tag_name": "美食"}
          ]
        }
      ],
      "pagination": {
        "total": 100,
        "page": 1,
        "limit": 10,
        "pages": 10
      }
    }
  }
  ```

### 获取游记详情

- **URL**: `/api/travel-logs/:id`
- **方法**: GET
- **身份认证**: 否
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取游记详情成功",
    "data": {
      "travel_log": {
        "log_id": 123,
        "title": "游记标题",
        "content": "游记内容",
        "image_urls": ["images/file1.webp"],
        "video_url": "videos/filename.mp4",
        "cover_url": "images/filename_cover.webp",
        "created_at": "2023-01-01T00:00:00Z",
        "updated_at": "2023-01-02T00:00:00Z",
        "comment_count": 5,
        "like_count": 10,
        "favorite_count": 2,
        "author": {
          "user_id": 456,
          "nickname": "作者昵称",
          "avatar": "avatars/avatar.webp"
        },
        "tags": [
          {"tag_id": 1, "tag_name": "北京"},
          {"tag_id": 2, "tag_name": "美食"}
        ],
        "comments": [
          {
            "comment_id": 789,
            "content": "评论内容",
            "created_at": "2023-01-03T00:00:00Z",
            "author": {
              "user_id": 101,
              "nickname": "评论者昵称",
              "avatar": "avatars/commenter.webp"
            }
          }
        ]
      }
    }
  }
  ```

### 获取个人游记列表

- **URL**: `/api/travel-logs/me`
- **方法**: GET
- **身份认证**: 是
- **查询参数**:
  - `page`: 页码(默认1)
  - `limit`: 每页数量(默认10)
  - `status`: 游记状态筛选(pending/approved/rejected，可选)
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取个人游记列表成功",
    "data": {
      "travel_logs": [
        {
          "log_id": 123,
          "title": "游记标题",
          "content": "游记内容",
          "image_urls": ["images/file1.webp"],
          "video_url": "videos/filename.mp4",
          "cover_url": "images/filename_cover.webp",
          "status": "pending",
          "created_at": "2023-01-01T00:00:00Z",
          "updated_at": "2023-01-02T00:00:00Z",
          "comment_count": 0,
          "like_count": 0,
          "favorite_count": 0,
          "tags": [
            {"tag_id": 1, "tag_name": "北京"},
            {"tag_id": 2, "tag_name": "美食"}
          ],
          "reject_reason": "拒绝原因(仅当status为rejected时)"
        }
      ],
      "pagination": {
        "total": 20,
        "page": 1,
        "limit": 10,
        "pages": 2
      }
    }
  }
  ```

### 更新游记

- **URL**: `/api/travel-logs/:id`
- **方法**: PUT
- **身份认证**: 是
- **URL参数**:
  - `id`: 游记ID
- **请求体**:
  ```json
  {
    "title": "更新的标题",
    "content": "更新的内容",
    "image_urls": ["images/file1.webp", "images/file3.webp"],
    "video_url": "videos/new_video.mp4",
    "cover_url": "images/new_video_cover.webp",
    "tags": ["上海", "美食"]
  }
  ```
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "游记更新成功，等待审核",
    "data": {
      "travel_log": {
        "log_id": 123,
        "title": "更新的标题",
        "status": "pending",
        "updated_at": "2023-01-05T00:00:00Z"
      }
    }
  }
  ```

### 删除游记

- **URL**: `/api/travel-logs/:id`
- **方法**: DELETE
- **身份认证**: 是
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "游记删除成功"
  }
  ```

## 评论接口

### 创建评论

- **URL**: `/api/comments`
- **方法**: POST
- **身份认证**: 是
- **请求体**:
  ```json
  {
    "log_id": 123,
    "content": "评论内容"
  }
  ```
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "评论发表成功",
    "data": {
      "comment": {
        "comment_id": 789,
        "content": "评论内容",
        "created_at": "2023-01-05T00:00:00Z"
      }
    }
  }
  ```

### 获取游记评论

- **URL**: `/api/travel-logs/:id/comments`
- **方法**: GET
- **身份认证**: 否
- **URL参数**:
  - `id`: 游记ID
- **查询参数**:
  - `page`: 页码(默认1)
  - `limit`: 每页数量(默认20)
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取评论成功",
    "data": {
      "comments": [
        {
          "comment_id": 789,
          "content": "评论内容",
          "created_at": "2023-01-05T00:00:00Z",
          "author": {
            "user_id": 456,
            "nickname": "评论者昵称",
            "avatar": "avatars/avatar.webp"
          }
        }
      ],
      "pagination": {
        "total": 50,
        "page": 1,
        "limit": 20,
        "pages": 3
      }
    }
  }
  ```

### 删除评论

- **URL**: `/api/comments/:id`
- **方法**: DELETE
- **身份认证**: 是
- **URL参数**:
  - `id`: 评论ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "评论删除成功"
  }
  ```

## 交互接口

### 点赞游记

- **URL**: `/api/travel-logs/:id/like`
- **方法**: POST
- **身份认证**: 是
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "点赞成功",
    "data": {
      "like_count": 11
    }
  }
  ```

### 取消点赞

- **URL**: `/api/travel-logs/:id/like`
- **方法**: DELETE
- **身份认证**: 是
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "取消点赞成功",
    "data": {
      "like_count": 10
    }
  }
  ```

### 收藏游记

- **URL**: `/api/travel-logs/:id/favorite`
- **方法**: POST
- **身份认证**: 是
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "收藏成功",
    "data": {
      "favorite_count": 3
    }
  }
  ```

### 取消收藏

- **URL**: `/api/travel-logs/:id/favorite`
- **方法**: DELETE
- **身份认证**: 是
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "取消收藏成功",
    "data": {
      "favorite_count": 2
    }
  }
  ```

### 获取我的收藏

- **URL**: `/api/users/favorites`
- **方法**: GET
- **身份认证**: 是
- **查询参数**:
  - `page`: 页码(默认1)
  - `limit`: 每页数量(默认10)
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取收藏列表成功",
    "data": {
      "favorites": [
        {
          "log_id": 123,
          "title": "游记标题",
          "image_urls": ["images/file1.webp"],
          "video_url": "videos/filename.mp4",
          "cover_url": "images/filename_cover.webp",
          "created_at": "2023-01-01T00:00:00Z",
          "favorite_time": "2023-01-06T00:00:00Z",
          "author": {
            "user_id": 456,
            "nickname": "作者昵称",
            "avatar": "avatars/avatar.webp"
          }
        }
      ],
      "pagination": {
        "total": 15,
        "page": 1,
        "limit": 10,
        "pages": 2
      }
    }
  }
  ```

## 审核接口 (仅管理员和审核员)

### 获取待审核游记列表

- **URL**: `/api/audit/travel-logs`
- **方法**: GET
- **身份认证**: 是
- **权限要求**: admin, reviewer
- **查询参数**:
  - `page`: 页码(默认1)
  - `limit`: 每页数量(默认10)
  - `status`: 状态过滤(pending/approved/rejected/all，默认pending)
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取游记列表成功",
    "data": {
      "travel_logs": [
        {
          "log_id": 123,
          "title": "游记标题",
          "content": "游记内容",
          "image_urls": ["images/file1.webp"],
          "video_url": "videos/filename.mp4",
          "cover_url": "images/filename_cover.webp",
          "status": "pending",
          "created_at": "2023-01-01T00:00:00Z",
          "updated_at": "2023-01-02T00:00:00Z",
          "author": {
            "user_id": 456,
            "nickname": "作者昵称",
            "avatar": "avatars/avatar.webp"
          },
          "auditRecords": [
            {
              "audit_id": 999,
              "audit_status": "rejected",
              "reason": "之前的拒绝原因",
              "audit_time": "2023-01-03T00:00:00Z",
              "reviewer": {
                "user_id": 789,
                "nickname": "审核员昵称"
              }
            }
          ]
        }
      ],
      "pagination": {
        "total": 35,
        "page": 1,
        "limit": 10,
        "pages": 4
      }
    }
  }
  ```

### 获取单个游记详情(审核)

- **URL**: `/api/audit/travel-logs/:id`
- **方法**: GET
- **身份认证**: 是
- **权限要求**: admin, reviewer
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "获取游记详情成功",
    "data": {
      "travel_log": {
        "log_id": 123,
        "title": "游记标题",
        "content": "游记内容",
        "image_urls": ["images/file1.webp"],
        "video_url": "videos/filename.mp4",
        "cover_url": "images/filename_cover.webp",
        "status": "pending",
        "created_at": "2023-01-01T00:00:00Z",
        "updated_at": "2023-01-02T00:00:00Z",
        "author": {
          "user_id": 456,
          "nickname": "作者昵称",
          "avatar": "avatars/avatar.webp"
        },
        "auditRecords": [
          {
            "audit_id": 999,
            "audit_status": "rejected",
            "reason": "之前的拒绝原因",
            "audit_time": "2023-01-03T00:00:00Z",
            "reviewer": {
              "user_id": 789,
              "nickname": "审核员昵称"
            }
          }
        ]
      }
    }
  }
  ```

### 审核游记

- **URL**: `/api/audit/travel-logs/:id`
- **方法**: POST
- **身份认证**: 是
- **权限要求**: admin, reviewer
- **URL参数**:
  - `id`: 游记ID
- **请求体**:
  ```json
  {
    "audit_status": "approved", // 或 "rejected"
    "reason": "拒绝原因（仅当status为rejected时必填）"
  }
  ```
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "游记审核通过", // 或 "游记审核拒绝"
    "data": {
      "travel_log": {
        "log_id": 123,
        "status": "approved" // 或 "rejected"
      }
    }
  }
  ```

### 删除游记(仅管理员)

- **URL**: `/api/audit/travel-logs/:id`
- **方法**: DELETE
- **身份认证**: 是
- **权限要求**: admin
- **URL参数**:
  - `id`: 游记ID
- **成功响应**: 
  ```json
  {
    "status": "success",
    "message": "游记删除成功"
  }
  ```

## 错误响应

所有接口在出错时返回统一格式的错误信息：

```json
{
  "status": "error",
  "message": "错误信息",
  "error_code": "ERROR_CODE"  // 可选，特定的错误代码
}
```

### 常见HTTP状态码

- `200 OK`: 请求成功
- `201 Created`: 资源创建成功
- `400 Bad Request`: 请求参数错误
- `401 Unauthorized`: 未授权(未登录或token无效)
- `403 Forbidden`: 权限不足
- `404 Not Found`: 资源不存在
- `500 Internal Server Error`: 服务器内部错误

## 权限说明

系统共有三种用户角色：
- `user`: 普通用户，可以创建、查看和管理自己的内容
- `reviewer`: 审核员，可以审核内容但不能删除
- `admin`: 管理员，拥有所有权限，包括删除内容

每个API接口的访问都受权限控制，用户只能访问其权限范围内的接口。

## 文件上传说明

1. 上传图片支持JPEG, PNG, GIF, WebP格式，单个文件最大10MB
2. 上传视频支持MP4, MPEG, MOV, AVI格式，单个文件最大100MB
3. 上传头像支持JPEG, PNG, GIF, WebP格式，单个文件最大2MB
4. 上传的视频会自动提取封面图片，存储在images目录
5. 所有上传的图片和视频都可以通过下载API访问

## 文件路径说明

- 图片文件路径: `images/{filename}.webp`
- 视频文件路径: `videos/{filename}.mp4`
- 视频封面路径: `images/{filename}_cover.webp`
- 头像文件路径: `avatars/{filename}.webp`
